"use strict";if(window.addEventListener("load",function(e){if(document.documentElement.className+=" tr",document.querySelector("#app-stats")){var t=document.querySelector("[data-stats-url]").getAttribute("data-stats-url");t+="?get-stats&game_type",fetch(t).then(function(e){return e.json()}).then(function(e){var t=document.querySelector("#app-stats-template"),i=document.querySelector("#app-stats-position-template");for(var n in e){console.log(e);var a=e[n],o=t.content.cloneNode(!0);o.querySelector(".stats_game_type span").innerText=n;for(var r=0,s=a.length;r<s;r++){var c=i.content.cloneNode(!0);c.querySelector(".stats_uname").innerText=a[r].uname,c.querySelector(".stats_score").innerText=a[r].score;var l=new Date(1e3*a[r].date);c.querySelector(".stats_date").innerText=l.toLocaleDateString(),o.querySelector(".stats_game").appendChild(c)}document.querySelector("#app_stats_container").appendChild(o)}})}}),document.querySelector("#app")){Vue.component("game2048-award",{template:"#game2048-award",props:{award:{type:Object,required:!0},style:{type:Object},likeStyle:{type:Object}}}),function(){var t=[1,1,.8,.65,.5,.4,.35,.32],e=[];e[2]="#87E293",e[4]="#87E273",e[8]="#eecf40",e[16]="#ffaa4f",e[64]="#9ebbee",e[32]="#6bcae2",e[128]="white";var i=[];i[2]="white",i[4]="white",i[8]="white",i[16]="white",i[32]="white",i[64]="white",i[128]="#2c3e50",Vue.component("game2048-chip",{template:"#game2048-chip",props:{chip:{type:Object},sizePx:{type:Number},animationTimeMs:{type:Number}},computed:{style:function(){return{fontSize:this.fontSizePx+"px",backgroundColor:this.backColor,color:this.color,boxShadow:this.boxShadow}},fontSizePx:function(){var e=Math.floor(Math.log(this.chip.value)/Math.log(10));return Math.floor(this.sizePx/1.5)*(e<8?t[e]:t[7])},backColor:function(){return e[this.chip.value]||e[128]},color:function(){return i[this.chip.value]||i[128]},boxShadow:function(){if(this.chip.value<256){var e=.1*this.sizePx+"px ";return"0 "+e+e+"0 black"}return"0 0 20px "+(2+Math.min(10,Math.log(this.chip.value)/Math.log(2)-7))+"px white"}},watch:{"chip.value":function(){var e=this.$el;if(e){var t=this.animationTimeMs+"ms";e.style["-webkit-animation"]=e.style.animation="chip-value-changed "+t,e.style.transition="background-color "+t,e.style["-webkit-transition"]="-web-kit-background-color "+t}}},methods:{enter:function(e,t){var i=this;if(this.chip.prevRelPos){var n=this.chip.prevRelPos;e.style["-webkit-transform"]=e.style.transform="translate("+n.left+"px,"+n.top+"px)",requestAnimationFrame(function(){requestAnimationFrame(function(){e.style.transition="transform "+i.animationTimeMs+"ms",e.style["-webkit-transition"]="-webkit-transform "+i.animationTimeMs+"ms",e.style["-webkit-transform"]=e.style.transform=""})})}else e.style["-webkit-animation"]=e.style.animation="chip-appear "+this.animationTimeMs+"ms"}}})}(),function(){var n={37:"left",38:"up",39:"right",40:"down"};Vue.component("game2048",{template:"#game2048",props:{size:{type:Number},sizeAimMap:{type:Array,required:!0},listenOwnKeyEventsOnly:{type:Boolean,default:!1},tabIndex:{type:Number,default:1},boardSizePx:{type:Number,default:0},animationTimeMs:{type:Number,default:150},started:{type:Boolean,default:!1}},data:function(){var e=this.sizeAimMap[this.size];return{cells:this.createCells(),boardSizeAutoPx:0,aim:e}},mounted:function(){this.boardSizeAutoPx=0<this.boardSizePx?this.boardSizePx:this.$el.getBoundingClientRect().width},watch:{size:function(){this.cells=this.createCells(),this.aim=this.sizeAimMap[this.size],this.$emit("aim-changed",this.aim)},started:function(e,t){e?this.startGame():this.endGame()}},computed:{boardStyle:function(){return{width:0<this.boardSizePx?this.boardSizePx+"px":"100%",height:0<this.boardSizePx?this.boardSizePx+"px":"100%",borderRadius:7/this.size+"%"}},cellStyle:function(){return{width:this.cellSizePct+"%",height:this.cellSizePct+"%",marginLeft:this.cellMarginPct+"%",marginTop:this.cellMarginPct+"%"}},cellSizePct:function(){return 8*this.cellMarginPct},cellMarginPct:function(){return 100/(9*this.size+1)},cellSizePx:function(){return this.cellSizePct/100*(0<this.boardSizePx?this.boardSizePx:this.boardSizeAutoPx)}},methods:{startGame:function(){this.emptyCells();for(var e=createGame2048(this.size),t=Math.max(2,this.size-2);0<t;t--){var i=e.turn();this.addChips(i)}var n=this.createGameMove(e);this.runKeyboardControl(n),this.runTouchControl(n),this.$emit("started",this)},runKeyboardControl:function(i){function e(e){var t=n[e.keyCode];null!=t&&(e.preventDefault(),i(t))}var t=this.listenOwnKeyEventsOnly?this.$el:document;t.addEventListener("keydown",e),this.$once("ended",function(){t.removeEventListener("keydown",e)})},runTouchControl:function(t){var r,s,e=(r=function(e){t(e)},{attach:function(e){e.addEventListener("touchstart",i,!1),e.addEventListener("touchend",n,!1)},detach:function(e){e.removeEventListener("touchstart",i),e.removeEventListener("touchend",n)}});function i(e){s=e.touches[0],e.preventDefault()}function n(e){var t=e.changedTouches[0],i=s.clientX-t.clientX,n=s.clientY-t.clientY,a=Math.abs(i),o=Math.abs(n);a<5&&o<5||r(o<a?0<i?"left":"right":0<n?"up":"down")}var a=this.$el;e.attach(a),this.$once("ended",function(){e.detach(a)})},createGameMove:function(n){var e,t,i,a=this,o={consolidations:[]},r=[],s=(e=a.animationTimeMs,i=!(t=function(){a.consolidateChips(o.consolidations),a.addChips(r)}),l(),{finish:c,renew:l});function c(){i||(t(),i=!0)}function l(){i=!1,setTimeout(c,e)}return function(e){if(s.finish(),o=n[e](),(r.length=0)<o.moves.length){for(var t=Math.max(1,a.size-3);0<t;t--){var i=n.turn();i.push.apply(r,i)}if(0<o.scoreInc){a.$emit("score",{score:n.score(),scoreInc:o.scoreInc});for(t=0;t<o.consolidations.length;t++)if(o.consolidations[t].value==a.aim){a.$emit("aim-reached");break}}}a.moveChips(o.moves),s.renew(),n.canMove()||setTimeout(function(){a.endGame()},a.animationTimeMs)}},endGame:function(){this.$emit("ended",this)},consolidateChips:function(e){var i=this;e.forEach(function(e){var t=i.getCell(e).chips;t.splice(0,t.length-1),t[0].value=e.value})},moveChips:function(e){for(var t=0;t<e.length;t++)this.moveChip(e[t].from,e[t].to)},moveChip:function(e,t){var i=this.getCell(e),n=this.getCellEl(e),a=this.getCell(t),o=this.getCellEl(t),r=i.chips.splice(0,1)[0],s=n.getBoundingClientRect(),c=o.getBoundingClientRect();r.prevRelPos={left:s.left-c.left,top:s.top-c.top},a.chips.push(r)},addChips:function(e){e.forEach(this.addChip)},addChip:function(e){this.cells[this.getCellIndex(e)].chips.push({value:e.value})},getCellIndex:function(e){return e.y*this.size+e.x},getCell:function(e){return this.cells[this.getCellIndex(e)]},getCellEl:function(e){return this.$refs.cells[this.getCellIndex(e)]},createCells:function(){return Array.apply(null,{length:this.size*this.size}).map(function(){return{chips:[]}})},emptyCells:function(){this.cells.forEach(function(e){e.chips.splice(0)})}}})}();var defBoardSizePx=420,defSize=4;localStorage.getItem("size")&&(defSize=parseInt(localStorage.getItem("size"),10));var app=new Vue({el:"#app",data:function(){var e=[];e[3]=256,e[4]=2048,e[5]=4096,e[6]=8192,e[7]=16384;var t={},i={},n=[],a=0;for(var o in e){var r=e[o];i[o]=0,t[r]={aim:r,obtained:!1},n[a++]=o}return{boardSizePx:defBoardSizePx,size:defSize,sizes:n,sizeAimMap:e,gameStarted:!1,gameEnded:!1,gameAim:e[defSize],gameAimReached:!1,score:0,scoreInc:"",bestScore:i,awards:t}},created:function(){this.loadState()},mounted:function(){var e=this;requestAnimationFrame(function(){e.fitBoardSizePx(),requestAnimationFrame(function(){e.$el.style.visibility="visible",e.showCollectAllAwards()})})},computed:{gameOverStyle:function(){return{fontSize:this.boardSizePx/6+"px"}},gameContainerStyle:function(){return{height:this.boardSizePx+"px"}},mainContainerStyle:function(){return{}},gameControlsStyle:function(){return{height:.2*this.boardSizePx+"px"}},scoreContainerStyle:function(){return{}},gameAimStyle:function(){var e=this.boardSizePx/50+"px ";return{boxShadow:"0 "+e+e+"black",fontSize:this.boardSizePx/110+"em"}},buttonStyle:function(){return{fontSize:this.boardSizePx/450+"em"}},scoreStyle:function(){return{fontSize:this.boardSizePx/280+"em"}},gameAwardsContainerStyle:function(){return{}},gameAwardStyle:function(){return{fontSize:this.boardSizePx/350+"em"}},gameAwardLikeStyle:function(){return{height:this.boardSizePx/21+"px"}},allAwardsObtained:function(){for(var e in this.awards)if(!this.awards[e].obtained)return!1;return!0}},watch:{size:function(){this.gameEnded=!1}},methods:{fitBoardSizePx:function(){window.innerWidth<1.04*defBoardSizePx?this.boardSizePx=.96*window.innerWidth:this.boardSizePx=defBoardSizePx},loadState:function(){try{var e=JSON.stringify(localStorage);if(e=JSON.parse(e)){var t=e;if(t)for(var i in t)try{this[i]=JSON.parse(t[i])}catch(e){this[i]=t[i]}}}catch(e){console.error(e)}},persistState:function(){try{var e={size:this.size,bestScore:this.bestScore,awards:this.awards};for(var t in e)localStorage.setItem(t,JSON.stringify(e[t]))}catch(e){console.error(e)}},startGame:function(){this.gameStarted=!0,this.score=0,this.showCollectAllAwards()},onGameStarted:function(){this.persistState(),this.gameStarted=!0,this.gameEnded=!1},onGameEnded:function(){this.gameStarted=!1,this.gameEnded=!0,this.gameAimReached=!1,this.persistState(),navigator.onLine&&this.score>=this.bestScore[this.size]&&this.sendStats("?check-stats",{gameType:this.size,gameScore:this.bestScore[this.size]})},sendStats:function(e,n){var a=document.querySelector("[data-stats-url]").getAttribute("data-stats-url"),t=a+e;n.gameType&&(t=t+"&game_type="+n.gameType),n.gameScore&&(t=t+"&score="+n.gameScore),fetch(t).then(function(e){return e.json()}).then(function(e){if(console.log(e),e.success.position){var t="";for(localStorage.getItem("uname")&&(t=localStorage.getItem("uname"));!i;){var i=prompt("You are in the top players in position "+e.success.position+".\nPlease enter your name:",t);if("string"!=typeof i)return}localStorage.setItem("uname",i),fetch(a+"?set-stats&game_type="+n.gameType+"&score="+n.gameScore+"&uname="+i).then(function(e){return e.json()}).then(function(e){console.log(e)})}})},onGameScore:function(e){var t={score:this.score},i=this;if(TweenLite.to(t,.3,{score:e.score,ease:Power0.easeNone,onUpdate:function(){i.score=Math.floor(t.score)}}),e.score>this.bestScore[this.size]){var n={score:this.bestScore[this.size]};TweenLite.to(n,.3,{score:e.score,ease:Power0.easeNone,onUpdate:function(){Vue.set(i.bestScore,i.size,Math.floor(n.score))}})}this.scoreInc=e.scoreInc+"+",Vue.nextTick(function(){i.scoreInc=""})},onGameAimChanged:function(e){this.gameAim=e},onGameAimReached:function(){this.gameAimReached=!0,this.awards[this.gameAim].obtained=!0,this.persistState();var e=this.getAwardEl(this.gameAim),t=this.$refs.gameAim.getBoundingClientRect(),i=e.getBoundingClientRect(),n=t.width/i.width,a=t.height/i.height,o=t.left-i.left+t.width/4,r=t.top-i.top+t.height/2,s=e.style;s["-webkit-transform"]=s.transform="translate("+o+"px,"+r+"px) scale("+n+","+a+")",s["-webkit-transition"]=s.transition="",s.zIndex=100,requestAnimationFrame(function(){s["-webkit-transition"]=s.transition="all 2s",s["-webkit-transform"]=s.transform=""})},getAwardEl:function(e){for(var t in this.$refs.awards){var i=this.$refs.awards[t];if(i.award.aim==e)return i.$el}return null},showCollectAllAwards:function(){var e=this.$refs.collectAllAwards.style;e["-webkit-animation"]=e.animation="",requestAnimationFrame(function(){e["-webkit-animation"]=e.animation="collect-all-awards 10s"})}}})}"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js"),"serviceWorker"in navigator&&window.addEventListener("beforeinstallprompt",function(e){var t;if(e.preventDefault(),t=e,document.querySelector(".header_buttons")){if(!document.querySelector("#a2hs")){var i=document.createElement("BUTTON");i.setAttribute("id","a2hs"),i.setAttribute("class","i_star"),"ru"===document.querySelector("html").getAttribute("lang")?i.setAttribute("title","Установить как приложение"):i.setAttribute("title","Install as application"),document.querySelector(".header_buttons").appendChild(i)}document.querySelector("#a2hs").addEventListener("click",function(e){t.prompt(),t.userChoice.then(function(e){t=null})})}if(document.querySelector("[data-pwa-install]"))for(var n=document.querySelectorAll("[data-pwa-install]"),a=0,o=n.length;a<o;a++)n[a].addEventListener("click",function(e){t.prompt(),t.userChoice.then(function(e){t=null})});window.addEventListener("appinstalled",function(e){document.querySelector("#a2hs")&&(document.querySelector("#a2hs").className+=" dn"),console.log("pwa installed")})});